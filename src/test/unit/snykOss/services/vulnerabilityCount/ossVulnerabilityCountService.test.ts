import { strictEqual } from 'assert';
import sinon from 'sinon';
import { IConfiguration } from '../../../../../snyk/common/configuration/configuration';
import { TextDocument, TextEditor } from '../../../../../snyk/common/vscode/types';
import { IVSCodeWindow } from '../../../../../snyk/common/vscode/window';
import { IVSCodeWorkspace } from '../../../../../snyk/common/vscode/workspace';
import { OssFileResult } from '../../../../../snyk/snykOss/ossResult';
import { OssService } from '../../../../../snyk/snykOss/services/ossService';
import { NpmModuleInfoFetchService } from '../../../../../snyk/snykOss/services/vulnerabilityCount/npmModuleInfoFetchService';
import { OssVulnerabilityCountService } from '../../../../../snyk/snykOss/services/vulnerabilityCount/ossVulnerabilityCountService';
import { ModuleVulnerabilityCountProvider } from '../../../../../snyk/snykOss/services/vulnerabilityCount/vulnerabilityCountProvider';
import { LoggerMock } from '../../../mocks/logger.mock';

suite('OSS VulnerabilityCountService', () => {
  let workspace: IVSCodeWorkspace;
  let window: IVSCodeWindow;
  let config: IConfiguration;
  let ossVulnerabilityCountService: OssVulnerabilityCountService;
  let ossService: OssService;
  let vulnerabilityCountProvider: ModuleVulnerabilityCountProvider;

  setup(() => {
    const logger = new LoggerMock();
    const npmModuleInfoFetchService = {} as NpmModuleInfoFetchService;
    ossService = {} as OssService;
    workspace = {} as IVSCodeWorkspace;
    window = {} as IVSCodeWindow;
    config = {
      isDevelopment: false,
    } as IConfiguration;
    vulnerabilityCountProvider = new ModuleVulnerabilityCountProvider(ossService, npmModuleInfoFetchService);

    ossVulnerabilityCountService = new OssVulnerabilityCountService(
      workspace,
      window,
      config,
      vulnerabilityCountProvider,
      ossService,
      logger,
    );
  });

  teardown(() => {
    sinon.restore();
  });

  test("Doesn't activate in development", () => {
    config.isDevelopment = true;
    strictEqual(ossVulnerabilityCountService.activate(), false);
  });

  test('Attaches onDidChangeTextDocument listener on activation', () => {
    window.onDidChangeActiveTextEditor = sinon.fake();
    window.getActiveTextEditor = sinon.fake();

    const onDidChangeTextDocumentSpy = sinon.fake();
    workspace.onDidChangeTextDocument = onDidChangeTextDocumentSpy;

    ossVulnerabilityCountService.activate();

    strictEqual(onDidChangeTextDocumentSpy.calledOnce, true);
  });

  test('Attaches onDidChangeActiveTextEditor listener on activation', () => {
    workspace.onDidChangeTextDocument = sinon.fake();
    window.getActiveTextEditor = sinon.fake();

    const onDidChangeActiveTextEditor = sinon.fake();
    window.onDidChangeActiveTextEditor = onDidChangeActiveTextEditor;

    ossVulnerabilityCountService.activate();

    strictEqual(onDidChangeActiveTextEditor.calledOnce, true);
  });

  test('Processes file if active editor is opened on activation', () => {
    window.getActiveTextEditor = () =>
      (({
        document: undefined,
      } as unknown) as TextEditor);
    workspace.onDidChangeTextDocument = sinon.fake();
    window.onDidChangeActiveTextEditor = sinon.fake();

    const getActiveTextEditorSpy = sinon.spy(window, 'getActiveTextEditor');
    const processFileSpy = sinon.spy(ossVulnerabilityCountService, 'processFile');

    ossVulnerabilityCountService.activate();

    strictEqual(getActiveTextEditorSpy.called, true);
    strictEqual(processFileSpy.calledOnce, true);
  });

  test("Doesn't process if file is language not supported", () => {
    const document = {
      fileName: 'C:\\git\\project\\test.java',
      languageId: 'java',
    } as TextDocument;

    const processed = ossVulnerabilityCountService.processFile(document);
    strictEqual(processed, false);
  });

  test("Doesn't process if file is JS/TS and OSS scan hasn't run", () => {
    ossService.getResultArray = () => undefined;
    const tsDocument = {
      fileName: 'C:\\git\\project\\test.ts',
      languageId: 'typescript',
    } as TextDocument;
    const jsDocument = {
      fileName: 'C:\\git\\project\\test.js',
      languageId: 'javascript',
    } as TextDocument;

    strictEqual(ossVulnerabilityCountService.processFile(tsDocument), false);
    strictEqual(ossVulnerabilityCountService.processFile(jsDocument), false);
  });

  test('Successful file processing', () => {
    const document = {
      fileName: 'C:\\git\\project\\test.ts',
      languageId: 'typescript',
      getText: () => 'const x = require("react")',
    } as TextDocument;
    ossService.getResultArray = () => [{} as OssFileResult];
    sinon.stub(vulnerabilityCountProvider, 'isFilePartOfOssTest').returns(true);

    const processed = ossVulnerabilityCountService.processFile(document);

    strictEqual(processed, true);
  });
});
